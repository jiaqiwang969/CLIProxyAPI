# Token çœ‹æ¿ - é›†æˆæŒ‡å—

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

Token çœ‹æ¿æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Web åº”ç”¨ï¼Œç”¨äºå®æ—¶ç›‘æ§ API ä½¿ç”¨æƒ…å†µå’Œ Token æ¶ˆè€—ã€‚å®ƒåŒ…æ‹¬ï¼š

- **åç«¯ API** (Go)ï¼šå¤„ç†ç»Ÿè®¡ã€æ—¥å¿—ã€å¯†é’¥ç®¡ç†
- **å‰ç«¯ç•Œé¢** (Vue 3)ï¼šæä¾›ç”¨æˆ·å‹å¥½çš„ Web ç•Œé¢
- **æ•°æ®ç®¡ç†**ï¼šå†…å­˜å­˜å‚¨ï¼Œæ”¯æŒå¹¶å‘è®¿é—®

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·æµè§ˆå™¨                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Token çœ‹æ¿å‰ç«¯ (Vue 3)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   ä»ªè¡¨æ¿     â”‚  â”‚   æ—¥å¿—é¡µé¢   â”‚  â”‚  å¯†é’¥ç®¡ç†    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTP/REST API
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Token çœ‹æ¿åç«¯ (Go)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           ConsoleManager                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”‚
â”‚  â”‚  â”‚  ç»Ÿè®¡ä¿¡æ¯    â”‚  â”‚  æ—¥å¿—ç®¡ç†    â”‚             â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”‚
â”‚  â”‚  â”‚  å¯†é’¥ç®¡ç†    â”‚  â”‚  è¶‹åŠ¿æ•°æ®    â”‚             â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           HTTP Handler                          â”‚  â”‚
â”‚  â”‚  /api/console/stats                             â”‚  â”‚
â”‚  â”‚  /api/console/logs                              â”‚  â”‚
â”‚  â”‚  /api/console/keys                              â”‚  â”‚
â”‚  â”‚  /api/console/usage-trend                       â”‚  â”‚
â”‚  â”‚  /api/console/export                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ é›†æˆæ­¥éª¤

### ç¬¬ 1 æ­¥ï¼šæ³¨å†Œè·¯ç”±

åœ¨ä¸»æœåŠ¡å™¨åˆå§‹åŒ–ä»£ç ä¸­æ·»åŠ ï¼š

```go
package main

import (
    "github.com/gin-gonic/gin"
    "github.com/router-for-me/CLIProxyAPI/v6/internal/console"
)

func main() {
    router := gin.Default()

    // åˆ›å»º Token çœ‹æ¿ç®¡ç†å™¨
    consoleManager := console.NewConsoleManager()

    // åˆ›å»ºå¤„ç†ç¨‹åº
    consoleHandler := console.NewHandler(consoleManager)

    // æ³¨å†Œè·¯ç”±
    consoleHandler.RegisterRoutes(router)

    // å¯åŠ¨æœåŠ¡
    router.Run(":8317")
}
```

### ç¬¬ 2 æ­¥ï¼šè®°å½• API è°ƒç”¨

åœ¨ API å¤„ç†ç¨‹åºä¸­è®°å½•è°ƒç”¨ï¼š

```go
// åœ¨å¤„ç† API è¯·æ±‚æ—¶
func handleChatCompletion(c *gin.Context) {
    // ... å¤„ç†è¯·æ±‚ ...

    // è®°å½• API è°ƒç”¨
    consoleManager.RecordLog(
        c.Request.Method,           // æ–¹æ³•
        c.Request.URL.Path,         // ç«¯ç‚¹
        modelName,                  // æ¨¡å‹åç§°
        c.Writer.Status(),          // çŠ¶æ€ç 
        tokensUsed,                 // æ¶ˆè€—çš„ Token
        duration,                   // è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
    )
}
```

### ç¬¬ 3 æ­¥ï¼šè®¿é—®çœ‹æ¿

å¯åŠ¨æœåŠ¡åï¼Œè®¿é—®ï¼š

```
http://localhost:8317/console
```

---

## ğŸ“¦ æ–‡ä»¶ç»“æ„

```
CLIProxyAPI/
â”œâ”€â”€ internal/
â”‚   â””â”€â”€ console/
â”‚       â”œâ”€â”€ manager.go           # æ ¸å¿ƒç®¡ç†å™¨
â”‚       â”œâ”€â”€ handler.go           # HTTP å¤„ç†ç¨‹åº
â”‚       â””â”€â”€ manager_test.go      # å•å…ƒæµ‹è¯•
â””â”€â”€ web/
    â””â”€â”€ token-console/
        â”œâ”€â”€ public/
        â”‚   â””â”€â”€ index.html       # å‰ç«¯ç•Œé¢
        â””â”€â”€ README.md            # ä½¿ç”¨æŒ‡å—
```

---

## ğŸš€ éƒ¨ç½²æŒ‡å—

### å¼€å‘ç¯å¢ƒ

```bash
# 1. ç¼–è¯‘ä»£ç 
go build -o cli-proxy-api ./cmd/server/main.go

# 2. è¿è¡ŒæœåŠ¡
./cli-proxy-api -config config.yaml

# 3. è®¿é—®çœ‹æ¿
# æ‰“å¼€æµè§ˆå™¨è®¿é—® http://localhost:8317/console
```

### ç”Ÿäº§ç¯å¢ƒ

#### ä½¿ç”¨ Docker

```dockerfile
FROM golang:1.21-alpine AS builder

WORKDIR /app
COPY . .

RUN go build -o cli-proxy-api ./cmd/server/main.go

FROM alpine:latest

WORKDIR /app
COPY --from=builder /app/cli-proxy-api .
COPY --from=builder /app/web ./web
COPY --from=builder /app/config.yaml .

EXPOSE 8317

CMD ["./cli-proxy-api", "-config", "config.yaml"]
```

æ„å»ºå’Œè¿è¡Œï¼š

```bash
# æ„å»ºé•œåƒ
docker build -t cli-proxy-api:latest .

# è¿è¡Œå®¹å™¨
docker run -p 8317:8317 cli-proxy-api:latest
```

#### ä½¿ç”¨ Systemd

åˆ›å»º `/etc/systemd/system/cli-proxy-api.service`ï¼š

```ini
[Unit]
Description=CLIProxyAPI Token Console
After=network.target

[Service]
Type=simple
User=api
WorkingDirectory=/opt/cli-proxy-api
ExecStart=/opt/cli-proxy-api/cli-proxy-api -config /opt/cli-proxy-api/config.yaml
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

å¯åŠ¨æœåŠ¡ï¼š

```bash
sudo systemctl daemon-reload
sudo systemctl enable cli-proxy-api
sudo systemctl start cli-proxy-api
```

---

## ğŸ”Œ API é›†æˆç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šåœ¨ Claude å¤„ç†ç¨‹åºä¸­é›†æˆ

```go
package handlers

import (
    "github.com/router-for-me/CLIProxyAPI/v6/internal/console"
)

type ClaudeHandler struct {
    consoleManager *console.ConsoleManager
}

func (h *ClaudeHandler) HandleChatCompletion(c *gin.Context) {
    startTime := time.Now()

    // ... å¤„ç†è¯·æ±‚ ...

    // è®°å½• API è°ƒç”¨
    duration := time.Since(startTime).Milliseconds()
    h.consoleManager.RecordLog(
        "POST",
        "/v1/chat/completions",
        modelName,
        http.StatusOK,
        tokensUsed,
        duration,
    )
}
```

### ç¤ºä¾‹ 2ï¼šåœ¨ä¸­é—´ä»¶ä¸­é›†æˆ

```go
func ConsoleMiddleware(consoleManager *console.ConsoleManager) gin.HandlerFunc {
    return func(c *gin.Context) {
        startTime := time.Now()

        c.Next()

        // è®°å½• API è°ƒç”¨
        duration := time.Since(startTime).Milliseconds()
        consoleManager.RecordLog(
            c.Request.Method,
            c.Request.URL.Path,
            c.GetString("model"),
            c.Writer.Status(),
            c.GetInt64("tokens"),
            duration,
        )
    }
}

// ä½¿ç”¨ä¸­é—´ä»¶
router.Use(ConsoleMiddleware(consoleManager))
```

---

## ğŸ“Š æ•°æ®æµ

### Token ä½¿ç”¨æµç¨‹

```
1. ç”¨æˆ·å‘é€ API è¯·æ±‚
   â†“
2. æœåŠ¡å™¨å¤„ç†è¯·æ±‚
   â†“
3. è°ƒç”¨ consoleManager.RecordLog()
   â†“
4. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
   â†“
5. å­˜å‚¨æ—¥å¿—è®°å½•
   â†“
6. å‰ç«¯å®æ—¶æ˜¾ç¤ºæ›´æ–°
```

### æ—¥å¿—è®°å½•æµç¨‹

```
API è¯·æ±‚
  â†“
è®°å½•æ—¥å¿—ä¿¡æ¯
  â†“
æ›´æ–° API è°ƒç”¨è®¡æ•°
  â†“
æ›´æ–° Token æ¶ˆè€—
  â†“
æ›´æ–°æ¨¡å‹ç»Ÿè®¡
  â†“
ä¿æŒæ—¥å¿—æ•°é‡åœ¨é™åˆ¶å†…
```

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. API å¯†é’¥ç®¡ç†

- å¯†é’¥å€¼åœ¨å‰ç«¯æ˜¾ç¤ºæ—¶è¢«éšè—
- æ”¯æŒåˆ›å»ºå’Œåˆ é™¤å¯†é’¥
- è®°å½•å¯†é’¥çš„æœ€åä½¿ç”¨æ—¶é—´

### 2. è®¿é—®æ§åˆ¶

å»ºè®®æ·»åŠ èº«ä»½éªŒè¯ä¸­é—´ä»¶ï¼š

```go
func AuthMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        token := c.GetHeader("Authorization")
        if token == "" {
            c.JSON(http.StatusUnauthorized, gin.H{
                "code": 401,
                "msg":  "Unauthorized",
            })
            c.Abort()
            return
        }
        c.Next()
    }
}

// ä½¿ç”¨
api := router.Group("/api/console")
api.Use(AuthMiddleware())
```

### 3. æ•°æ®éšç§

- ä¸å­˜å‚¨æ•æ„Ÿä¿¡æ¯
- å®šæœŸæ¸…ç†æ—§æ—¥å¿—
- æ”¯æŒæ•°æ®å¯¼å‡ºå’Œå¤‡ä»½

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. æ—¥å¿—é™åˆ¶

```go
// è®¾ç½®æœ€å¤§æ—¥å¿—æ•°
consoleManager.maxLogs = 10000
```

### 2. å¹¶å‘è®¿é—®

ConsoleManager ä½¿ç”¨ `sync.RWMutex` æ”¯æŒå¹¶å‘è®¿é—®ï¼š

```go
// è¯»æ“ä½œï¼ˆå¤šä¸ª goroutine å¯ä»¥å¹¶å‘æ‰§è¡Œï¼‰
stats := consoleManager.GetStats()
logs := consoleManager.GetLogs(100)

// å†™æ“ä½œï¼ˆäº’æ–¥æ‰§è¡Œï¼‰
consoleManager.RecordLog(...)
consoleManager.CreateAPIKey(...)
```

### 3. ç¼“å­˜ç­–ç•¥

```go
// ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
var cachedStats *TokenStats
var cacheTime time.Time

func GetStatsCached() *TokenStats {
    if time.Since(cacheTime) < 5*time.Second {
        return cachedStats
    }
    cachedStats = consoleManager.GetStats()
    cacheTime = time.Now()
    return cachedStats
}
```

---

## ğŸ§ª æµ‹è¯•

### è¿è¡Œå•å…ƒæµ‹è¯•

```bash
go test ./internal/console/... -v
```

### è¿è¡ŒåŸºå‡†æµ‹è¯•

```bash
go test ./internal/console/... -bench=. -benchmem
```

### æµ‹è¯•è¦†ç›–ç‡

```bash
go test ./internal/console/... -cover
```

---

## ğŸ“ é…ç½®ç¤ºä¾‹

### config.yaml

```yaml
# Token çœ‹æ¿é…ç½®
console:
  enabled: true
  port: 8317
  path: /console
  max_logs: 1000
  max_keys: 100

  # æ—¥å¿—ä¿ç•™æ—¶é—´ï¼ˆå¤©ï¼‰
  log_retention_days: 30

  # è‡ªåŠ¨æ¸…ç†é—´éš”ï¼ˆå°æ—¶ï¼‰
  cleanup_interval: 24
```

### ç¯å¢ƒå˜é‡

```bash
# Token çœ‹æ¿ç«¯å£
export CONSOLE_PORT=8317

# Token çœ‹æ¿è·¯å¾„
export CONSOLE_PATH=/console

# æœ€å¤§æ—¥å¿—æ•°
export CONSOLE_MAX_LOGS=1000

# æœ€å¤§å¯†é’¥æ•°
export CONSOLE_MAX_KEYS=100
```

---

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ 1ï¼šçœ‹æ¿æ— æ³•è®¿é—®

```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
curl http://localhost:8317/console

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
tail -f logs/error.log

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
lsof -i :8317
```

### é—®é¢˜ 2ï¼šAPI è¿”å› 500 é”™è¯¯

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
grep -i console logs/error.log

# æ£€æŸ¥è¯·æ±‚å‚æ•°
curl -X GET http://localhost:8317/api/console/stats | jq '.'
```

### é—®é¢˜ 3ï¼šæ—¥å¿—æ•°æ®ä¸æ›´æ–°

```bash
# æ£€æŸ¥ RecordLog æ˜¯å¦è¢«è°ƒç”¨
grep -i "RecordLog" logs/debug.log

# æ‰‹åŠ¨åˆ·æ–°çœ‹æ¿
curl http://localhost:8317/api/console/logs
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Token çœ‹æ¿ä½¿ç”¨æŒ‡å—](./README.md)
- [API æ–‡æ¡£](./API.md)
- [éƒ¨ç½²æŒ‡å—](./DEPLOYMENT.md)

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰
- [ ] éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
- [ ] è¿›è¡ŒåŠŸèƒ½æµ‹è¯•
- [ ] æ”¶é›†ç”¨æˆ·åé¦ˆ

### ä¸­æœŸï¼ˆ1 ä¸ªæœˆï¼‰
- [ ] æ·»åŠ æ•°æ®åº“æ”¯æŒï¼ˆæŒä¹…åŒ–å­˜å‚¨ï¼‰
- [ ] å®ç°æ•°æ®å¯¼å‡ºåŠŸèƒ½
- [ ] æ·»åŠ å‘Šè­¦åŠŸèƒ½

### é•¿æœŸï¼ˆ2-3 ä¸ªæœˆï¼‰
- [ ] å®ç°å®æ—¶é€šçŸ¥
- [ ] æ·»åŠ é«˜çº§åˆ†æåŠŸèƒ½
- [ ] æ”¯æŒå¤šç”¨æˆ·å’Œæƒé™ç®¡ç†

---

## ğŸ“ è·å–å¸®åŠ©

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—
tail -f logs/error.log

# æœç´¢ç‰¹å®šé”™è¯¯
grep -i "error" logs/error.log
```

### æµ‹è¯• API

```bash
# è·å–ç»Ÿè®¡ä¿¡æ¯
curl http://localhost:8317/api/console/stats | jq '.'

# è·å–æ—¥å¿—
curl http://localhost:8317/api/console/logs | jq '.'

# åˆ›å»ºå¯†é’¥
curl -X POST http://localhost:8317/api/console/keys \
  -H "Content-Type: application/json" \
  -d '{"name":"test-key","description":"test"}'
```

---

**éœ€è¦å¸®åŠ©ï¼Ÿ** æŸ¥çœ‹å®Œæ•´æ–‡æ¡£æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚
